<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>CAR/VEN METAR &amp; TAF + Bonaire Visibility</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@600;800&display=swap"
    rel="stylesheet"
  />

  <style>
    :root {
      --bg:        #101820;
      --panel:     #1a2a33;
      --line:      #2a3b47;
      --accent:    #66ffcc;
      --text:      #f2f7fa;
      --muted:     #4f5b62;
      --warn:      #ff6666;
      --highlight: var(--accent);
    }
    *, *::before, *::after { box-sizing: border-box }
    body {
      margin: 0; padding: 24px;
      font-family: 'Inter', sans-serif;
      background: var(--bg);
      color: var(--text);
      position: relative;
    }

    /* Copy flash animation */
    @keyframes copyFlash {
      from { background-color: var(--highlight); }
      to   { background-color: transparent; }
    }
    td.copied {
      animation: copyFlash 0.6s ease-out;
    }

    /* Bonaire Visibility */
    #bonaire-vis-widget {
      position: absolute; top:24px; left:24px;
      width:260px;
      background: var(--panel);
      border:2px solid var(--line);
      border-radius:8px;
      padding:16px;
      cursor:pointer;
    }
    #bonaire-vis-widget h2 {
      margin:0 0 8px; font-size:20px; font-weight:600;
      color:var(--accent);
    }
    #bonaire-vis-widget .vis-value {
      font-size:28px; font-weight:800;
    }
    #bonaire-vis-widget .vis-value.low {
      color:var(--warn);
    }
    #bonaire-vis-widget .timestamp {
      margin-top:8px; font-size:14px; color:var(--muted);
    }

    /* Header & Controls */
    h1 { text-align:center; margin-top:0;
         font-size:32px; font-weight:800; color:var(--accent); }
    #clocks {
      display:flex; justify-content:center; gap:40px;
      font-size:36px; margin:16px 0 24px;
    }
    #controls { text-align:center; margin-bottom:24px; }
    #controls button {
      background:var(--panel); color:var(--accent);
      border:2px solid var(--line); border-radius:4px;
      padding:8px 16px; font-size:18px; margin:0 8px;
      cursor:pointer; transition:background .3s, color .3s;
    }
    #controls button:hover {
      background:var(--accent); color:var(--panel);
    }

    /* METAR Table */
    .table-wrapper { overflow-x:auto; margin-bottom:16px; }
    table {
      width:100%; border-collapse:collapse;
      font-family:monospace; font-size:30px;
    }
    th, td {
      border:2px solid var(--line);
      padding:12px 16px; text-align:center;
      user-select:none;
    }
    th {
      background:#003b5a; color:var(--accent);
      font-weight:700;
    }
    td.station {
      font-weight:700; color:var(--accent);
      font-size:36px;
    }
    td.time { font-size:32px; transition:.5s; }
    td.vis  { font-size:28px; }
    tr.stale { opacity:.5; }
    td.time.stale { opacity:.5; color:var(--muted)!important; }
    .alert { background:var(--warn); color:var(--bg); }
    .highlight { background:var(--highlight); color:var(--bg); }
    tr.alert-row td { border:2px solid var(--warn)!important; }

    /* Raw METAR row */
    tr.raw td {
      background:var(--panel);
      padding:12px 16px; text-align:left;
      user-select:text;
    }
    .raw-current {
      display:block; font-family:monospace;
      font-size:20px; color:#d0d7de;
      white-space:pre-wrap; word-break:break-word;
    }
    .raw-past {
      display:block; margin-top:4px;
      font-family:monospace; font-size:18px;
      color:var(--muted);
      white-space:pre-wrap; word-break:break-word;
    }

    /* TAF Table */
    .taf-wrapper { overflow-x:auto; margin-bottom:24px; }
    #taf-table {
      width:100%; border-collapse:collapse;
      font-family:monospace; font-size:18px;
    }
    #taf-table th, #taf-table td {
      border:2px solid var(--line);
      padding:12px 16px; text-align:left;
      vertical-align:top;
    }
    #taf-table th {
      background:#003b5a; color:var(--accent);
      font-weight:700;
    }
    #taf-table td.decoded {
      white-space:pre-wrap; word-break:break-word;
    }

    #last-updated, #taf-updated {
      text-align:center; font-size:14px;
      color:var(--muted); margin:8px 0 24px;
    }
  </style>
</head>
<body>

  <!-- Bonaire Visibility -->
  <div id="bonaire-vis-widget" title="Double-click to refresh">
    <h2>üëÅÔ∏è Bonaire Visibility</h2>
    <div class="vis-value" id="vis-value">Loading‚Ä¶</div>
    <div class="timestamp" id="vis-timestamp"></div>
  </div>

  <h1>REGIONAL</h1>

  <!-- Clocks -->
  <div id="clocks">
    <div>Local: <span id="local-clock">--:--:--</span></div>
    <div>UTC:   <span id="utc-clock">--:--:--</span></div>
  </div>

  <!-- Controls -->
  <div id="controls">
    <button id="mute-btn">Mute Beep</button>
    <button id="refresh-btn">Refresh Now</button>
    <button id="test-btn">Enter Test Mode</button>
  </div>

  <!-- METAR Table -->
  <div class="table-wrapper">
    <table>
      <thead>
        <tr>
          <th>ICAO</th><th>Time</th><th>Wind</th><th>Vis</th>
          <th>Wx</th><th>Clouds</th><th>Temp/Dew</th><th>QNH</th>
        </tr>
      </thead>
      <tbody id="metar"></tbody>
    </table>
  </div>
  <div id="last-updated">METAR last updated: --:--:--</div>

  <!-- TAF Table -->
  <div class="taf-wrapper">
    <table id="taf-table">
      <thead><tr id="taf-header"></tr></thead>
      <tbody>
        <tr id="taf-row"></tr>
      </tbody>
    </table>
  </div>
  <div id="taf-updated">TAF last updated: --:--:--</div>

  <script>
  (async function() {
    const proxy       = 'https://api.allorigins.win/raw?url=';
    const stations    = ['TNCA','TNCB','TNCC','TNCM','SVMI','SVVA'];
    const tafEndpoints = stations.slice(0,3).map(icao => ({
      icao,
      url: `https://tgftp.nws.noaa.gov/data/forecasts/taf/stations/${icao}.TXT`
    }));

    let beepEnabled = true, testMode = false;
    const metarRows = {}, metarHist = {};

    // Time helpers
    function pad(n){ return n < 10 ? '0'+n : ''+n; }
    function nowStamp() {
      const d = new Date();
      return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }
    function updateClocks() {
      const d = new Date();
      document.getElementById('local-clock').textContent =
        `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
      document.getElementById('utc-clock').textContent =
        `${pad(d.getUTCHours())}:${pad(d.getUTCMinutes())}:${pad(d.getUTCSeconds())}`;
    }
    setInterval(updateClocks, 500);
    updateClocks();

    // Fetch text via CORS proxy
    async function fetchText(url) {
      const res = await fetch(proxy + encodeURIComponent(url));
      if (!res.ok) throw new Error('Fetch failed');
      return res.text();
    }

    // METAR parsing
    function cleanForParse(s) {
      return s.replace(/\sRMK[\s\S]*/i,'')
              .replace(/\s(?:TEMPO|BECMG|PROB\d{2}|FM\d{6})[\s\S]*/i,'')
              .replace(/\bAUTO\b|\bCOR\b/gi,'')
              .trim();
    }
    function parseMetar(raw) {
      const t    = cleanForParse(raw).split(/\s+/);
      const time = t[1] || '--';
      const wind = t.find(x=>/^(?:VRB|\d{3})\d{2}(?:G\d{2})?KT$/.test(x)) || '--';
      const vis  = t.find(x=>/^\d{4}$/.test(x)) || '--';
      const wx   = t.filter(x=>/^(?:\+|-)?(?:TS|SH|RA|DZ|SN|FG|BR).*/.test(x)).join(' ') || '--';
      const cld  = t.filter(x=>/^(?:FEW|SCT|BKN|OVC).*/.test(x)).join(' ') || '--';
      const td   = t.find(x=>/^M?\d{2}\/M?\d{2}$/.test(x)) || '--';
      const qp   = t.find(x=>/^Q\d{4}$/.test(x));
      let qnh = '‚Äî';
      if (qp) {
        const h = qp.slice(1);
        const i = (parseInt(h) * 0.02953).toFixed(2);
        qnh = `${h}-${i}`;
      }
      const gust = +(wind.match(/G(\d{2})/)?.[1] || 0);
      let age = 0;
      if (/^\d{6}Z$/.test(time)) {
        const now = new Date(),
              dd  = parseInt(time.slice(0,2)),
              hh  = parseInt(time.slice(2,4)),
              mm  = parseInt(time.slice(4,6));
        const dUTC = Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), dd, hh, mm);
        age = (Date.now() - dUTC) / 60000;
      }
      return { time, wind, vis, wx, cld, td, qnh, gust, age };
    }

    // Build METAR table rows
    function buildMetar() {
      const tb = document.getElementById('metar');
      tb.innerHTML = '';
      stations.forEach(icao => {
        const tr  = document.createElement('tr');
        const trR = document.createElement('tr');
        trR.className = 'raw';
        tr.innerHTML = `
          <td class="station">${icao}</td>
          <td class="time">--</td>
          <td>--</td><td class="vis">--</td>
          <td>--</td><td>--</td>
          <td>--</td><td>--</td>`;
        trR.innerHTML = `
          <td colspan="8">
            <span class="raw-current">Waiting‚Ä¶</span>
            <span class="raw-past"></span>
          </td>`;
        tb.append(tr, trR);
        metarRows[icao] = {
          row:  tr,
          curr: trR.querySelector('.raw-current'),
          past: trR.querySelector('.raw-past')
        };
        metarHist[icao] = [];
      });
    }

    function scheduleHighlight(cell) {
      clearTimeout(cell._t);
      cell.classList.add('highlight');
      cell._t = setTimeout(() => cell.classList.remove('highlight'), 20 * 60 * 1000);
    }

    // Load & render METAR data
    async function loadMetar() {
      for (const icao of stations) {
        try {
          const txt = testMode
            ? `${icao} 121900Z AUTO COR 09025G35KT 5000 VCSH FEW020 BKN040 28/24 Q1013`
            : await fetchText(`https://tgftp.nws.noaa.gov/data/observations/metar/stations/${icao}.TXT`);
          const rawLine = txt.trim().split(/\r?\n/).pop();
          const d       = parseMetar(rawLine);
          const hist    = metarHist[icao];
          const isNew   = hist[0] && hist[0] !== rawLine;
          if (!hist[0] || hist[0] !== rawLine) {
            hist.unshift(rawLine);
            if (hist.length > 2) hist.pop();
          }
          // audio alerts
          if (icao === 'TNCA' && beepEnabled && (d.gust >= 35 || /TS/.test(d.wx))) {
            new Audio('https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg').play();
          }
          if (isNew && beepEnabled) {
            new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg').play();
          }
          // render
          const r = metarRows[icao];
          const alertCond = d.gust > 0 ||
                            parseInt(d.vis,10) < 5000 ||
                            d.wx !== '--' ||
                            /CB/.test(d.cld);
          r.row.classList.toggle('stale', d.age > 120);
          r.row.classList.toggle('alert-row', alertCond);
          r.row.querySelector('.station').classList.toggle('alert', alertCond);
          const cells = r.row.querySelectorAll('td');
          cells[1].textContent = d.time;       if (isNew) scheduleHighlight(cells[1]);
          cells[2].textContent = d.wind;
          cells[3].textContent = d.vis;
          cells[4].textContent = d.wx;
          cells[5].textContent = d.cld;
          cells[6].textContent = d.td;
          cells[7].textContent = d.qnh;
          r.curr.textContent = hist[0] || '';
          r.past.textContent = hist[1] || '';
        } catch (err) {
          console.error('METAR load error for', icao, err);
        }
      }
      document.getElementById('last-updated').textContent =
        `METAR last updated: ${nowStamp()}`;
    }

    // Decode and render TAF data
    function decodeTaf(raw) {
      const out   = [];
      const issue = raw.match(/\b\d{6}Z\b/)?.[0];
      if (issue) out.push('Issued ' + issue);
      const range = raw.match(/\b(\d{4})\/(\d{4})\b/)?.slice(1) || [];
      if (range.length === 2) out.push(`Valid ${range[0]}‚Äì${range[1]}Z`);
      const parts = raw.split(/(?=FM\d{6}|TEMPO|BECMG|PROB\d{2})/);
      parts.forEach(p => {
        const tag = p.match(/^(FM\d{6}|TEMPO|BECMG|PROB\d{2})/)?.[1] || '';
        let label = '';
        if (tag.startsWith('FM')) {
          label = `From ${tag.slice(2,4)}:${tag.slice(4,6)}Z`;
        } else if (tag) {
          label = tag;
        }
        const w = p.match(/(\d{3})(\d{2})G?(\d{2})?KT/);
        if (w) {
          out.push(`${label} wind ${w[1]}¬∞@${w[2]}kt${w[3]? 'G'+w[3]+'kt':''}`);
        }
        const v = p.match(/ (\d{4}) /);
        if (v) out.push(`${label} vis ${v[1]}m`);
        const c = p.match(/(FEW|SCT|BKN|OVC)(\d{3})/);
        if (c) {
          const map = { FEW:'Few', SCT:'Scat', BKN:'Brk', OVC:'Ovc' };
          out.push(`${label} ${map[c[1]]} ${c[2]}00ft`);
        }
      });
      return out.join('<br/>');
    }

    async function loadTaf() {
      const hdr = document.getElementById('taf-header');
      const row = document.getElementById('taf-row');
      hdr.innerHTML = tafEndpoints.map(t => `<th>${t.icao}</th>`).join('');
      const decoded = await Promise.all(tafEndpoints.map(async t => {
        try {
          let raw = await fetchText(t.url);
          raw = raw.trim().replace(/\r?\n/g,' ');
          return decodeTaf(raw);
        } catch {
          return 'N/A';
        }
      }));
      row.innerHTML = decoded.map(d => `<td class="decoded">${d}</td>`).join('');
      document.getElementById('taf-updated').textContent =
        `TAF last updated: ${nowStamp()}`;
    }

    // Bonaire visibility widget
    (function(){
      const URL = 'https://www.knmidc.org/weather/bonaire/?Current';
      const REF = 5 * 60 * 1000;
      const ALERT = 20000;
      const visEl = document.getElementById('vis-value');
      const tsEl  = document.getElementById('vis-timestamp');
      const wd    = document.getElementById('bonaire-vis-widget');
      async function upd() {
        let v = 'N/A', t = Date.now();
        try {
          const html = await fetch(proxy + encodeURIComponent(URL)).then(r=>r.text());
          const doc  = new DOMParser().parseFromString(html,'text/html');
          doc.querySelectorAll('td').forEach(td=>{
            if (/Visibility/i.test(td.textContent)) {
              const nxt = td.nextElementSibling;
              if (nxt) v = nxt.textContent.trim();
            }
          });
        } catch(e) {
          console.error('Visibility load error', e);
        }
        visEl.textContent = v;
        visEl.classList.toggle('low', parseInt(v,10) < ALERT);
        tsEl.textContent  = `Updated ${new Date(t).toLocaleTimeString()}`;
      }
      wd.ondblclick = upd;
      upd();
      setInterval(upd, REF);
    })();

    // Initialize
    buildMetar();
    await loadMetar();
    await loadTaf();
    setInterval(loadMetar, 60*1000);
    setInterval(loadTaf, 10*60*1000);

    // Controls
    document.getElementById('mute-btn').onclick = () => {
      beepEnabled = !beepEnabled;
      document.getElementById('mute-btn').textContent =
        beepEnabled ? 'Mute Beep' : 'Unmute Beep';
    };
    document.getElementById('refresh-btn').onclick = () => {
      loadMetar();
      loadTaf();
    };
    document.getElementById('test-btn').onclick = () => {
      testMode = !testMode;
      document.getElementById('test-btn').textContent =
        testMode ? 'Exit Test Mode' : 'Enter Test Mode';
      loadMetar();
      loadTaf();
    };

    // Enable double-click copy on all <td>
    document.body.addEventListener('dblclick', async e => {
      const td = e.target.closest('td');
      if (!td) return;
      const txt = td.textContent.trim();
      try {
        await navigator.clipboard.writeText(txt);
        td.classList.add('copied');
        setTimeout(() => td.classList.remove('copied'), 600);
      } catch {}
    });

  })();
  </script>
</body>
</html>
```

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>CAR/VEN METAR AND TAF</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@600;800&display=swap" rel="stylesheet"/>
  <style>
    :root {
      --bg:        #101820;
      --panel:     #1a2a33;
      --line:      #2a3b47;
      --accent:    #66ffcc;
      --text:      #f2f2f2;
      --muted:     #4f5b62;
      --warn:      #ff6666;
      --highlight: var(--accent);
    }
    *, *::before, *::after { box-sizing:border-box; }
    body {
      margin:0; padding:24px;
      font-family:'Inter',sans-serif;
      background:var(--bg); color:var(--text);
      font-size:22px; line-height:1.4;
    }
    h1 {
      margin:0 0 16px;
      text-align:center;
      font-size:42px; font-weight:800;
      color:var(--accent);
    }
    #clocks {
      display:flex; justify-content:center; gap:40px;
      font-size:24px; margin-bottom:20px; color:var(--accent);
    }
    #controls { text-align:center; margin-bottom:16px; }
    #controls button {
      background:var(--panel); color:var(--accent);
      border:2px solid var(--line); padding:8px 16px;
      font-size:18px; margin:0 8px; cursor:pointer;
    }
    #controls button:hover { background:var(--accent); color:var(--panel); }

    .table-wrapper { overflow-x:auto; margin-bottom:8px; }
    table {
      width:100%; border-collapse:collapse;
      font-family:monospace; font-size:30px;
    }
    th, td {
      border:2px solid var(--line);
      padding:12px 16px; text-align:center;
      user-select:none;
    }
    th { background:#003b5a; color:var(--accent); font-weight:700; }
    td.station { font-weight:700; color:var(--accent); font-size:36px; }
    td.time { font-size:32px; transition:background .5s, color .5s; }
    .highlight { background:var(--accent); color:var(--bg); }
    .alert { background:var(--warn); color:var(--bg); }
    tr.raw td {
      background:var(--panel);
      color:#d0d7de;
      text-align:left;
      font-size:20px;
      padding:8px 16px;
      user-select:text; /* allow selecting and copying the raw METAR */
    }
    #last-updated, #taf-updated { font-size:14px; color:var(--muted); margin:8px 0; }
    #compact-taf {
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(360px,1fr));
      gap:16px; margin-bottom:8px;
    }
    .taf-card {
      background:var(--panel); border:2px solid var(--line);
      border-radius:8px; padding:16px;
    }
    .taf-code { font-family:monospace; font-weight:700; color:var(--accent); font-size:28px; }
    .taf-issue { font-size:20px; color:var(--muted); margin-left:12px; }
    .taf-body { margin-top:12px; font-family:monospace; font-size:22px; line-height:1.4; word-break:break-word; }
  </style>
</head>
<body>

  <h1>CAR/VEN METAR AND TAF</h1>
  <div id="clocks">
    <div>Local: <span id="local-clock">--:--:--</span></div>
    <div>UTC:   <span id="utc-clock">--:--:--</span></div>
  </div>

  <div id="controls">
    <button id="mute-btn">Mute Beep</button>
    <button id="refresh-btn">Refresh Now</button>
    <button id="test-btn">Enter Test Mode</button>
  </div>

  <div class="table-wrapper">
    <table>
      <thead>
        <tr>
          <th>ICAO</th><th>Time</th><th>Wind</th><th>Vis</th>
          <th>Wx</th><th>Clouds</th><th>Temp/Dew</th><th>QNH</th>
        </tr>
      </thead>
      <tbody id="metar"></tbody>
    </table>
  </div>
  <div id="last-updated">METAR last updated: --:--:--</div>

  <div id="compact-taf"><div>Loading TAF…</div></div>
  <div id="taf-updated">TAF last updated: --:--:--</div>

  <script>
  (async function(){
    const proxy    = 'https://api.allorigins.win/raw?url=';
    const stations = ['TNCA','TNCB','TNCC','TNCM','SVMI','SVVA'];
    const tafs     = [
      {c:'TNCC',u:'https://tgftp.nws.noaa.gov/data/raw/ft/ftnu31.tncc..txt'},
      {c:'EHDB',u:'https://tgftp.nws.noaa.gov/data/raw/ft/ftdc31.ehdb..txt'},
      {c:'TNCA',u:'https://tgftp.nws.noaa.gov/data/raw/ft/ftnu50.tnca..txt'}
    ];

    const metarTbody = document.getElementById('metar'),
          tafDiv      = document.getElementById('compact-taf'),
          lastUp      = document.getElementById('last-updated'),
          tafUp       = document.getElementById('taf-updated'),
          muteBtn     = document.getElementById('mute-btn'),
          refreshBtn  = document.getElementById('refresh-btn'),
          testBtn     = document.getElementById('test-btn');

    let beepEnabled = true, testMode = false;

    const state = {}; // per-station: { raw, parsed, timeToken, lastChangeMs }
    const rows  = {}; // per-station DOM refs

    function pad(n){ return n<10?'0'+n:n; }
    function nowStamp(){
      const d = new Date();
      return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }
    function updateClocks(){
      const d = new Date();
      document.getElementById('local-clock').textContent =
        `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
      document.getElementById('utc-clock').textContent   =
        `${pad(d.getUTCHours())}:${pad(d.getUTCMinutes())}:${pad(d.getUTCSeconds())}`;
    }
    setInterval(updateClocks,500); updateClocks();

    // Clean for parsing only: strip RMK and trend groups so they never show in columns,
    // but keep the original raw line intact in the RAW row.
    function cleanForParse(s){
      return s
        .replace(/\sRMK[\s\S]*/i,'')
        .replace(/\s(?:TEMPO|BECMG|PROB\d{2}|FM\d{6})[\s\S]*/i,'')
        .replace(/\bAUTO\b|\bCOR\b/gi,'')
        .trim();
    }

    function parseMetar(raw){
      const tks  = cleanForParse(raw).split(/\s+/);
      const time = tks[1] || '';

      // Wind: include /////KT
      const mainWind = tks.find(x =>
        /^(?:VRB|\d{3})\d{2}(?:G\d{2})?KT$/.test(x) || /^\/{5}KT$/.test(x)
      ) || '';
      const varWind = tks.filter(x => /^\d{3}V\d{3}$/.test(x)).join(' ');
      const wind    = [mainWind, varWind].filter(Boolean).join(' ');
      const gustVal = +(mainWind.match(/G(\d{2})/)?.[1] || 0);
      const hasGust = gustVal > 0;

      // Visibility (basic 4-digit)
      const vis    = tks.find(x => /^\d{4}$/.test(x)) || '';
      const visNum = parseInt(vis,10) || 9999;
      const lowVis = visNum < 5000;

      // Weather: include VCSH plus usual codes
      const wx = tks.filter(x =>
        /^(?:\+|-)?(?:VC)?(?:MI|PR|BC|DR|BL|SH|TS|FZ)?(?:DZ|RA|SN|SG|PL|GR|GS|UP|BR|FG|FU|DU|SA|HZ|PY|PO|SQ|FC|SS|DS|VA)$/.test(x) ||
        x === 'VCSH'
      ).join(' ');
      const hasWx = !!wx;

      // Clouds
      const clouds = tks.filter(x => /^(?:FEW|SCT|BKN|OVC).*/.test(x)).join(' ');
      const hasCB  = /TCU|CB/.test(clouds);

      // Temp/Dew and QNH
      const td  = tks.find(x => /^M?\d{2}\/M?\d{2}$/.test(x)) || '';
      const qp  = tks.find(x => /^Q\d{4}$/.test(x));
      const qnh = qp ? `${qp.slice(1)}-${(parseInt(qp.slice(1),10)*0.02953).toFixed(2)}` : '—';

      return { time, wind, vis, wx, clouds, td, qnh, hasGust, gustVal, lowVis, hasWx, hasCB };
    }

    async function fetchText(url){
      const r = await fetch(proxy + encodeURIComponent(url));
      if(!r.ok) throw new Error('fetch failed');
      return r.text();
    }

    // Build fixed rows once so we can preserve "last known" data on errors.
    function buildTableSkeleton(){
      const frag = document.createDocumentFragment();
      for (const c of stations) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="station"></td>
          <td class="time">--</td>
          <td>--</td><td>--</td><td>--</td>
          <td>--</td><td>--</td><td>--</td>
        `;
        const trRaw = document.createElement('tr');
        trRaw.className = 'raw';
        trRaw.innerHTML = `<td colspan="8">Waiting for METAR…</td>`;

        frag.appendChild(tr);
        frag.appendChild(trRaw);

        const cells = tr.querySelectorAll('td');
        rows[c] = {
          row: tr,
          rawRow: trRaw,
          cStation: cells[0],
          cTime: cells[1],
          cWind: cells[2],
          cVis: cells[3],
          cWx: cells[4],
          cClouds: cells[5],
          cTd: cells[6],
          cQnh: cells[7],
          cRaw: trRaw.firstElementChild
        };

        rows[c].cStation.textContent = c;
      }
      metarTbody.innerHTML = '';
      metarTbody.appendChild(frag);
    }

    function applyStationRender(c, parsed, raw, isNewTime){
      const r = rows[c];
      if (!r) return;

      const hasAlert = parsed.hasGust || parsed.lowVis || parsed.hasWx || parsed.hasCB;

      r.cStation.classList.toggle('alert', hasAlert);
      r.cTime.textContent = parsed.time || '--';
      r.cTime.classList.toggle('highlight', !!isNewTime);

      r.cWind.textContent   = parsed.wind   || '--';
      r.cVis.textContent    = parsed.vis    || '--';
      r.cWx.textContent     = parsed.wx     || '--';
      r.cClouds.textContent = parsed.clouds || '--';
      r.cTd.textContent     = parsed.td     || '--';
      r.cQnh.textContent    = parsed.qnh    || '--';

      // Keep the raw line intact and selectable for copy
      r.cRaw.textContent = raw || r.cRaw.textContent;
    }

    async function loadMetar(){
      for (const c of stations) {
        try {
          if (testMode) {
            const raw = `${c} 121200Z 09025G36KT 5000 2000N VCSH +TSRA FEW///CB BKN016TCU Q1012 RMK TEST KEEP RAW`;
            const parsed = parseMetar(raw);
            const prevTime = state[c]?.timeToken;
            const isNew = prevTime && prevTime !== parsed.time;

            // Alerts and beeps
            if (c === 'TNCA' && beepEnabled && (parsed.gustVal >=35 || /TS/.test(parsed.wx))) {
              new Audio('https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg').play();
            }
            if (isNew && beepEnabled) {
              new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg').play();
            }

            state[c] = { raw, parsed, timeToken: parsed.time, lastChangeMs: Date.now() };
            applyStationRender(c, parsed, raw, true);
            continue;
          }

          const txt   = await fetchText(`https://tgftp.nws.noaa.gov/data/observations/metar/stations/${c}.TXT`);
          const lines = txt.trim().split(/\r?\n/).filter(Boolean);
          const raw   = lines.pop(); // last line is the METAR
          const parsed = parseMetar(raw);

          const prevTime = state[c]?.timeToken;
          const isNew = prevTime && prevTime !== parsed.time;

          if (c === 'TNCA' && beepEnabled && (parsed.gustVal >=35 || /TS/.test(parsed.wx))) {
            new Audio('https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg').play();
          }
          if (isNew && beepEnabled) {
            new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg').play();
          }

          state[c] = { raw, parsed, timeToken: parsed.time, lastChangeMs: Date.now() };
          applyStationRender(c, parsed, raw, isNew);
        } catch(e) {
          // Do nothing: keep last known data visible, show no error.
          // If there is no prior data, the skeleton "Waiting for METAR…" remains.
        }
      }
      lastUp.textContent = `METAR last updated: ${nowStamp()}`;
    }

    async function loadTaf(){
      try {
        if (testMode) {
          const cards = tafs.map(tf => `
            <div class="taf-card">
              <div>
                <span class="taf-code">${tf.c}</span>
                <span class="taf-issue">121200Z</span>
              </div>
              <div class="taf-body">TAF ${tf.c} 121130Z 1212/1318 09012KT P6SM FEW020 TEMPO 1218/1222 TSRA BKN030CB</div>
            </div>
          `).join('');
          tafDiv.innerHTML = cards;
          tafUp.textContent = `TAF last updated: ${nowStamp()}`;
          return;
        }

        // Attempt to fetch all; only update UI when at least one succeeds
        const results = [];
        for (const tf of tafs) {
          try {
            const txt = await fetchText(tf.u);
            const s   = cleanForParse(txt.replace(/\s+/g,' '));
            const issue = (s.match(/\b\d{4}Z\b/)||[])[0]||'';
            results.push(`
              <div class="taf-card">
                <div>
                  <span class="taf-code">${tf.c}</span>
                  <span class="taf-issue">${issue}</span>
                </div>
                <div class="taf-body">${s}</div>
              </div>
            `);
          } catch(_) {
            // Keep previous TAF display if this one fails
          }
        }
        if (results.length) {
          tafDiv.innerHTML = results.join('');
          tafUp.textContent = `TAF last updated: ${nowStamp()}`;
        }
      } catch(_) {
        // Suppress errors entirely
      }
    }

    // Copy-on-dblclick for table cells, except raw row (so user can select manually)
    document.querySelector('table').addEventListener('dblclick', e => {
      const td = e.target.closest('td');
      if (!td) return;
      if (td.parentElement.classList.contains('raw')) return; // allow manual selection for raw
      const text = td.textContent.trim();
      if (!text) return;
      navigator.clipboard.writeText(text).then(() => {
        td.classList.add('highlight');
        setTimeout(() => td.classList.remove('highlight'), 500);
      });
    });

    muteBtn.addEventListener('click',()=>{
      beepEnabled = !beepEnabled;
      muteBtn.textContent = beepEnabled ? 'Mute Beep' : 'Unmute Beep';
    });
    refreshBtn.addEventListener('click',()=>{ loadMetar(); loadTaf(); });
    testBtn.addEventListener('click',()=>{
      testMode = !testMode;
      testBtn.textContent = testMode ? 'Exit Test Mode' : 'Enter Test Mode';
      loadMetar(); loadTaf();
    });

    buildTableSkeleton();
    await loadMetar();
    await loadTaf();
    setInterval(loadMetar, 60*1000);
    setInterval(loadTaf, 10*60*1000);
  })();
  </script>
</body>
</html>
```

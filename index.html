<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>CAR/VEN METAR & TAF + Bonaire Visibility</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@600;800&display=swap"
    rel="stylesheet"
  />

  <style>
    :root {
      --bg:        #101820;
      --panel:     #1a2a33;
      --line:      #2a3b47;
      --accent:    #66ffcc;
      --text:      #f2f7fa;
      --muted:     #4f5b62;
      --warn:      #ff6666;
      --highlight: var(--accent);
    }
    *, *::before, *::after { box-sizing: border-box }
    body {
      margin: 0;
      padding: 24px;
      font-family: 'Inter', sans-serif;
      background: var(--bg);
      color: var(--text);
      position: relative;
    }

    /* Bonaire Visibility */
    #bonaire-vis-widget {
      position: absolute;
      top: 24px;
      left: 24px;
      width: 260px;
      background: var(--panel);
      border: 2px solid var(--line);
      border-radius: 8px;
      padding: 16px;
      cursor: pointer;
    }
    #bonaire-vis-widget h2 {
      margin: 0 0 8px;
      font-size: 20px;
      font-weight: 600;
      color: var(--accent);
    }
    #bonaire-vis-widget .vis-value {
      font-size: 28px;
      font-weight: 800;
    }
    #bonaire-vis-widget .vis-value.low {
      color: var(--warn);
    }
    #bonaire-vis-widget .timestamp {
      margin-top: 8px;
      font-size: 14px;
      color: var(--muted);
    }

    /* Header & Controls */
    h1 {
      text-align: center;
      margin-top: 0;
      font-size: 32px;       /* reduced from 42px */
      font-weight: 800;
      color: var(--accent);
    }
    #clocks {
      display: flex;
      justify-content: center;
      gap: 40px;
      font-size: 36px;       /* increased from 24px */
      margin: 16px 0 24px;
      color: var(--text);    /* white font */
    }
    #controls {
      text-align: center;
      margin-bottom: 24px;
    }
    #controls button {
      background: var(--panel);
      color: var(--accent);
      border: 2px solid var(--line);
      border-radius: 4px;
      padding: 8px 16px;
      font-size: 18px;
      margin: 0 8px;
      cursor: pointer;
      transition: background 0.3s, color 0.3s;
    }
    #controls button:hover {
      background: var(--accent);
      color: var(--panel);
    }

    /* METAR Table */
    .table-wrapper { overflow-x: auto; margin-bottom: 16px }
    table {
      width: 100%;
      border-collapse: collapse;
      font-family: monospace;
      font-size: 30px;
    }
    th, td {
      border: 2px solid var(--line);
      padding: 12px 16px;
      text-align: center;
      user-select: none;
    }
    th {
      background: #003b5a;
      color: var(--accent);
      font-weight: 700;
    }
    td.station {
      font-weight: 700;
      color: var(--accent);
      font-size: 36px;
    }
    td.time {
      font-size: 32px;
      transition: background 0.5s, color 0.5s, opacity 0.5s;
    }
    tr.stale { opacity: 0.5; transition: opacity 0.5s }
    td.time.stale { opacity: 0.5; color: var(--muted) !important }
    td.vis { font-size: 28px }
    .alert {
      background: var(--warn);
      color: var(--bg);
    }
    .highlight {
      background: var(--highlight);
      color: var(--bg);
    }
    tr.raw td {
      background: var(--panel);
      color: #d0d7de;
      text-align: left;
      font-size: 20px;
      padding: 8px 16px;
      user-select: text;
    }
    #last-updated, #taf-updated {
      text-align: center;
      font-size: 14px;
      color: var(--muted);
      margin: 8px 0 24px;
    }

    /* TAF Cards */
    #compact-taf {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(360px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    .taf-card {
      background: var(--panel);
      border: 2px solid var(--line);
      border-radius: 8px;
      padding: 16px;
    }
    .taf-code {
      font-family: monospace;
      font-weight: 700;
      color: var(--accent);
      font-size: 28px;
    }
    .taf-issue {
      font-size: 20px;
      color: var(--muted);
      margin-left: 12px;
    }
    .taf-body {
      margin-top: 12px;
      font-family: monospace;
      font-size: 22px;
      line-height: 1.4;
      white-space: pre-wrap;
      word-break: break-word;
    }
  </style>
</head>
<body>

  <!-- Bonaire Visibility Widget -->
  <div id="bonaire-vis-widget" title="Double-click to refresh">
    <h2>üëÅÔ∏è Bonaire Visibility</h2>
    <div class="vis-value" id="vis-value">Loading‚Ä¶</div>
    <div class="timestamp" id="vis-timestamp"></div>
  </div>

  <h1>REGIONAL</h1>

  <!-- Clocks -->
  <div id="clocks">
    <div>Local: <span id="local-clock">--:--:--</span></div>
    <div>UTC:   <span id="utc-clock">--:--:--</span></div>
  </div>

  <!-- Controls -->
  <div id="controls">
    <button id="mute-btn">Mute Beep</button>
    <button id="refresh-btn">Refresh Now</button>
    <button id="test-btn">Enter Test Mode</button>
  </div>

  <!-- METAR Table -->
  <div class="table-wrapper">
    <table>
      <thead>
        <tr>
          <th>ICAO</th><th>Time</th><th>Wind</th><th>Vis</th>
          <th>Wx</th><th>Clouds</th><th>Temp/Dew</th><th>QNH</th>
        </tr>
      </thead>
      <tbody id="metar"></tbody>
    </table>
  </div>
  <div id="last-updated">METAR last updated: --:--:--</div>

  <!-- TAF Cards -->
  <div id="compact-taf">Loading TAF‚Ä¶</div>
  <div id="taf-updated">TAF last updated: --:--:--</div>

  <script>
  (async function(){
    const proxy    = 'https://api.allorigins.win/raw?url=';
    const stations = ['TNCA','TNCB','TNCC','TNCM','SVMI','SVVA'];
    const tafs     = [
      {c:'TNCC',u:'https://tgftp.nws.noaa.gov/data/raw/ft/ftnu31.tncc..txt'},
      {c:'EHDB',u:'https://tgftp.nws.noaa.gov/data/raw/ft/ftdc31.ehdb..txt'},
      {c:'TNCA',u:'https://tgftp.nws.noaa.gov/data/raw/ft/ftnu50.tnca..txt'}
    ];

    const metarTbody = document.getElementById('metar'),
          tafDiv      = document.getElementById('compact-taf'),
          lastUp      = document.getElementById('last-updated'),
          tafUp       = document.getElementById('taf-updated'),
          muteBtn     = document.getElementById('mute-btn'),
          refreshBtn  = document.getElementById('refresh-btn'),
          testBtn     = document.getElementById('test-btn');

    let beepEnabled = true, testMode = false;
    const rows = {}, state = {}, highlightTimers = {};

    function pad(n){ return n < 10 ? '0' + n : '' + n; }
    function nowStamp(){
      const d = new Date();
      return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }

    function updateClocks(){
      const d = new Date();
      document.getElementById('local-clock').textContent =
        `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
      document.getElementById('utc-clock').textContent =
        `${pad(d.getUTCHours())}:${pad(d.getUTCMinutes())}:${pad(d.getUTCSeconds())}`;
    }
    setInterval(updateClocks, 500);
    updateClocks();

    async function fetchText(url){
      const res = await fetch(proxy + encodeURIComponent(url));
      if (!res.ok) throw new Error('Fetch failed');
      return res.text();
    }

    function cleanForParse(s){
      return s.replace(/\sRMK[\s\S]*/i, '')
              .replace(/\s(?:TEMPO|BECMG|PROB\d{2}|FM\d{6})[\s\S]*/i, '')
              .replace(/\bAUTO\b|\bCOR\b/gi, '')
              .trim();
    }

    function parseMetar(raw){
      const t = cleanForParse(raw).split(/\s+/);
      const timeTok = t[1] || '';
      const mainWind = t.find(x =>
        /^(?:VRB|\d{3})\d{2}(?:G\d{2})?KT$/.test(x) ||
        /^\/{5}KT$/.test(x)
      ) || '';
      const varWind = t.filter(x => /^\d{3}V\d{3}$/.test(x)).join(' ');
      const wind    = [mainWind,varWind].filter(Boolean).join(' ');

      let vis='', varVis='';
      t.forEach((x,i)=>{
        if(!vis && /^\d{4}$/.test(x)){
          vis = x;
          const nx = t[i+1];
          if(nx && /^\d{4}[NESW]$/.test(nx)) varVis = nx;
        }
      });

      const wx = t.filter(x=>
        /^(?:\+|-)?(?:VC)?(?:MI|PR|BC|DR|BL|SH|TS|FZ)?(?:DZ|RA|SN|SG|PL|GR|GS|UP|BR|FG|FU|DU|SA|HZ|PY|PO|SQ|FC|SS|DS|VA)$/.test(x)|| x==='VCSH'
      ).join(' ');
      const clouds = t.filter(x=>/^(?:FEW|SCT|BKN|OVC).*/.test(x)).join(' ');
      const td = t.find(x=>/^M?\d{2}\/M?\d{2}$/.test(x))||'';

      const qp = t.find(x=>/^Q\d{4}$/.test(x));
      let qnh = '‚Äî';
      if(qp){
        const hpa = qp.slice(1);
        const inch = (parseInt(hpa,10)*0.02953).toFixed(2);
        qnh = `${hpa} - ${inch}`;
      }

      let ageMins = 0;
      if(/^\d{6}Z$/.test(timeTok)){
        const now = new Date();
        const dd  = parseInt(timeTok.slice(0,2),10);
        const hh  = parseInt(timeTok.slice(2,4),10);
        const mm  = parseInt(timeTok.slice(4,6),10);
        const metUTC = Date.UTC(
          now.getUTCFullYear(), now.getUTCMonth(), dd, hh, mm
        );
        ageMins = (Date.now() - metUTC)/60000;
      }

      const gustVal = +(mainWind.match(/G(\d{2})/)?.[1]||0);
      const lowVis  = parseInt(vis,10) < 5000;
      const hasWx   = !!wx;
      const hasCB   = /TCU|CB/.test(clouds);

      return {time:timeTok, wind, vis, varVis, wx, clouds, td, qnh,
              gustVal, lowVis, hasWx, hasCB, ageMins};
    }

    function buildTable(){
      metarTbody.innerHTML='';
      stations.forEach(icao=>{
        const tr=document.createElement('tr'),
              trRaw=document.createElement('tr');
        trRaw.className='raw';
        tr.innerHTML=
          `<td class="station">${icao}</td>`+
          `<td class="time">--</td>`+
          `<td>--</td><td class="vis">--</td><td>--</td>`+
          `<td>--</td><td>--</td><td>--</td>`;
        trRaw.innerHTML=`<td colspan="8">Waiting for METAR‚Ä¶</td>`;
        metarTbody.append(tr,trRaw);
        const c=tr.querySelectorAll('td');
        rows[icao]={
          row:tr, raw:trRaw.firstElementChild,
          cStation:c[0], cTime:c[1], cWind:c[2],
          cVis:c[3], cWx:c[4], cClouds:c[5],
          cTd:c[6], cQnh:c[7]
        };
      });
    }

    function scheduleHighlight(icao, cell){
      clearTimeout(highlightTimers[icao]);
      cell.classList.add('highlight');
      highlightTimers[icao]=setTimeout(()=>{
        cell.classList.remove('highlight');
      },10*60*1000);
    }

    function renderStation(icao,data,raw,isNew){
      const r=rows[icao];
      if(!r) return;
      r.row.classList.toggle('stale', data.ageMins>120);
      r.cStation.classList.toggle('alert',
        data.gustVal>0||data.lowVis||data.hasWx||data.hasCB
      );
      r.cTime.textContent=data.time||'--';
      if(isNew) scheduleHighlight(icao,r.cTime);
      r.cWind.textContent=data.wind||'--';
      r.cVis.textContent=data.vis
        ? data.vis+(data.varVis?' '+data.varVis:'')
        : '--';
      r.cWx.textContent     = data.wx     || '--';
      r.cClouds.textContent = data.clouds|| '--';
      r.cTd.textContent     = data.td     || '--';
      r.cQnh.textContent    = data.qnh    || '--';
      r.raw.textContent     = raw||r.raw.textContent;
    }

    async function loadMetar(){
      for(const icao of stations){
        try{
          const txt = testMode
            ? `${icao} 121900Z AUTO COR 09025G35KT /////KT 5000 2000N VCSH +TSRA FEW///CB BKN080 28/24 Q1013 RMK TEST`
            : await fetchText(
                `https://tgftp.nws.noaa.gov/data/observations/metar/stations/${icao}.TXT`
              );
          const raw=txt.trim().split(/\r?\n/).pop();
          const data=parseMetar(raw);
          const prev=state[icao]?.time;
          const isNew=!!prev && data.time!==prev;
          if(icao==='TNCA'&&beepEnabled&&
            (data.gustVal>=35||/TS/.test(data.wx))){
            new Audio(
              'https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg'
            ).play();
          }
          if(isNew&&beepEnabled){
            new Audio(
              'https://actions.google.com/sounds/v1/alarms/beep_short.ogg'
            ).play();
          }
          state[icao]={time:data.time};
          renderStation(icao,data,raw,isNew);
        }catch{}
      }
      lastUp.textContent=`METAR last updated: ${nowStamp()}`;
    }

    async function loadTaf(){
      const cards=[];
      for(const tf of tafs){
        try{
          const txt=await fetchText(tf.u);
          const clean=txt.trim().replace(/\r?\n/g,' ');
          const issue=(clean.match(/\b\d{6}Z\b/)||[])[0]||'';
          cards.push(`
            <div class="taf-card">
              <div>
                <span class="taf-code">${tf.c}</span>
                <span class="taf-issue">${issue}</span>
              </div>
              <div class="taf-body">${clean}</div>
            </div>`);
        }catch{
          cards.push(`
            <div class="taf-card">
              <div><span class="taf-code">${tf.c}</span></div>
              <div class="taf-body">TAF not available</div>
            </div>`);
        }
      }
      tafDiv.innerHTML=cards.join('');
      tafUp.textContent=`TAF last updated: ${nowStamp()}`;
    }

    document.querySelector('table').addEventListener('dblclick',e=>{
      const td=e.target.closest('td');
      if(!td||td.parentElement.classList.contains('raw'))return;
      navigator.clipboard.writeText(td.textContent.trim()).then(()=>{
        td.classList.add('highlight');
        setTimeout(()=>td.classList.remove('highlight'),500);
      });
    });

    muteBtn.addEventListener('click',()=>{
      beepEnabled=!beepEnabled;
      muteBtn.textContent=beepEnabled?'Mute Beep':'Unmute Beep';
    });
    refreshBtn.addEventListener('click',()=>{loadMetar();loadTaf();});
    testBtn.addEventListener('click',()=>{
      testMode=!testMode;
      testBtn.textContent=testMode?'Exit Test Mode':'Enter Test Mode';
      loadMetar();loadTaf();
    });

    buildTable();
    loadMetar();
    loadTaf();
    setInterval(loadMetar,60*1000);
    setInterval(loadTaf,10*60*1000);
  })();
  </script>

  <script>
  (function(){
    const proxy='https://api.allorigins.win/raw?url=',
          URL='https://www.knmidc.org/weather/bonaire/?Current',
          CACHE_V='bonaire-vis',
          CACHE_T='bonaire-ts',
          REF=5*60*1000,
          ALERT=20000;

    const visEl=document.getElementById('vis-value'),
          tsEl=document.getElementById('vis-timestamp'),
          wdg=document.getElementById('bonaire-vis-widget');

    function pad(n){return n<10?'0'+n:''+n;}
    function ago(ms){
      const m=Math.floor((Date.now()-ms)/60000);
      if(m<1)return 'just now';
      return m===1?'1 minute ago':m+' minutes ago';
    }
    function display(v,t,cache){
      visEl.textContent=v;
      const num=parseInt(v.replace(/[^\d]/g,''),10);
      visEl.classList.toggle('low',Number.isFinite(num)&&num<ALERT);
      tsEl.textContent=cache
        ?`Cached ${ago(t)}`
        :`Updated at ${new Date(t).toLocaleTimeString()}`;
    }
    function loadCache(){
      const v=localStorage.getItem(CACHE_V),
            t=+localStorage.getItem(CACHE_T);
      if(v&&t)display(v,t,true);
    }
    async function fetchVis(){
      const res=await fetch(proxy+encodeURIComponent(URL));
      if(!res.ok)throw'';
      const html=await res.text();
      const doc=new DOMParser().parseFromString(html,'text/html');
      let vis='N/A';
      doc.querySelectorAll('td').forEach(td=>{
        if(/Visibility/i.test(td.textContent)){
          const nx=td.nextElementSibling;
          if(nx)vis=nx.textContent.trim();
        }
      });
      return vis;
    }
    async function update(force=false){
      const now=Date.now();
      try{
        const v=await fetchVis();
        display(v,now,false);
        localStorage.setItem(CACHE_V,v);
        localStorage.setItem(CACHE_T,now);
      }catch{
        if(!force)loadCache();
      }
    }
    wdg.addEventListener('dblclick',()=>update(true));
    loadCache();update();setInterval(update,REF);
  })();
  </script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>CAR/VEN METAR &amp; TAF + Bonaire Visibility + SYNOP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@600;800&display=swap"
    rel="stylesheet"
  />

  <style>
    :root {
      --bg:        #101820;
      --panel:     #1a2a33;
      --line:      #2a3b47;
      --accent:    #66ffcc;
      --text:      #f2f7fa;
      --muted:     #4f5b62;
      --warn:      #ff0000;
    }
    *, *::before, *::after { box-sizing: border-box }
    body {
      margin: 0; padding: 24px;
      font-family: 'Inter', sans-serif;
      background: var(--bg);
      color: var(--text);
      position: relative;
    }

    /* Highlight updated METAR time */
    td.highlight {
      background-color: var(--accent);
      color: var(--bg);
      font-weight: 700;
      transition: background-color .5s ease, color .5s ease;
    }

    /* Flash on copy */
    @keyframes copyFlash {
      from { background-color: var(--accent); }
      to   { background-color: transparent; }
    }
    td.metar-copied {
      animation: copyFlash .6s ease-out;
    }

    /* Alert border */
    td.alert {
      border: 3px solid var(--warn) !important;
    }

    /* Bonaire Visibility Widget */
    #bonaire-vis-widget {
      position: absolute; top:24px; left:24px;
      width:260px; background: var(--panel);
      border:2px solid var(--line); border-radius:8px; padding:16px;
      cursor:pointer;
    }
    #bonaire-vis-widget h2 {
      margin:0 0 8px; font-size:20px; font-weight:600;
      color:var(--accent);
    }
    #bonaire-vis-widget .vis-value {
      font-size:28px; font-weight:800;
    }
    #bonaire-vis-widget .vis-value.low {
      color:var(--warn);
    }
    #bonaire-vis-widget .timestamp {
      margin-top:8px; font-size:14px; color:var(--muted);
    }

    /* Header & Controls */
    h1 {
      text-align:center; margin-top:0;
      font-size:32px; font-weight:800; color:var(--accent);
    }
    #clocks {
      display:flex; justify-content:center; gap:40px;
      font-size:36px; margin:16px 0 24px;
    }
    #controls { text-align:center; margin-bottom:24px; }
    #controls button {
      background:var(--panel); color:var(--accent);
      border:2px solid var(--line); border-radius:4px;
      padding:8px 16px; font-size:18px; margin:0 8px;
      cursor:pointer; transition:background .3s, color .3s;
    }
    #controls button:hover {
      background:var(--accent); color:var(--panel);
    }

    /* Tables */
    .table-wrapper { overflow-x:auto; margin-bottom:16px; }
    table {
      width:100%; border-collapse:collapse;
      font-family:monospace; font-size:30px;
    }
    th, td {
      border:2px solid var(--line);
      padding:12px 16px; text-align:center;
      user-select:none;
    }
    th {
      background:#003b5a; color:var(--accent);
      font-weight:700;
    }
    tr.stale { opacity:.5; }

    /* METAR columns styling */
    td.station { font-weight:700; color:var(--accent); font-size:36px; }
    td.time    { font-size:32px; }
    td.vis     { font-size:28px; }

    /* Raw METAR lines */
    tr.raw td {
      background:var(--panel); text-align:left;
      padding:12px 16px; user-select:text;
    }
    .raw-current {
      display:block; font-family:monospace; font-size:22px;
      color:#d0d7de; white-space:pre-wrap; word-break:break-word;
    }
    .raw-past {
      display:block; margin-top:4px;
      font-family:monospace; font-size:20px;
      color:var(--muted); white-space:pre-wrap; word-break:break-word;
    }

    /* TAF & SYNOP tables */
    #taf-table, #synop-table {
      font-size:18px; margin-bottom:24px;
      border-collapse:collapse; width:100%;
    }
    #taf-table th, #taf-table td,
    #synop-table th, #synop-table td {
      border:2px solid var(--line);
      padding:8px 12px; text-align:left;
      font-family:monospace; user-select:none;
    }
    #taf-table th, #synop-table th {
      background:#003b5a; color:var(--accent);
      font-weight:700;
    }
    #taf-table td.station, #synop-table td.station {
      font-weight:700; color:var(--accent);
      text-align:center; font-size:20px;
    }
  </style>
</head>
<body>

  <!-- Bonaire Visibility -->
  <div id="bonaire-vis-widget" title="Double-click to refresh">
    <h2>üëÅÔ∏è Bonaire Visibility</h2>
    <div class="vis-value" id="vis-value">Loading‚Ä¶</div>
    <div class="timestamp" id="vis-timestamp"></div>
  </div>

  <h1>REGIONAL</h1>

  <!-- Clocks -->
  <div id="clocks">
    <div>Local: <span id="local-clock">--:--:--</span></div>
    <div>UTC:   <span id="utc-clock">--:--:--</span></div>
  </div>

  <!-- Controls -->
  <div id="controls">
    <button id="mute-btn">Mute Beep</button>
    <button id="refresh-btn">Refresh Now</button>
    <button id="test-btn">Enter Test Mode</button>
  </div>

  <!-- METAR Table -->
  <div class="table-wrapper">
    <table>
      <thead>
        <tr>
          <th>ICAO</th><th>Time</th><th>Wind</th><th>Vis</th>
          <th>Wx</th><th>Clouds</th><th>Temp/Dew</th><th>QNH</th>
        </tr>
      </thead>
      <tbody id="metar"></tbody>
    </table>
  </div>
  <div id="last-updated">METAR last updated: --:--:--</div>

  <!-- TAF Table -->
  <div class="table-wrapper">
    <table id="taf-table">
      <thead><tr><th>ICAO</th><th>Raw TAF</th></tr></thead>
      <tbody id="taf"></tbody>
    </table>
  </div>
  <div id="taf-updated">TAF last updated: --:--:--</div>

  <!-- SYNOP Table -->
  <div class="table-wrapper">
    <table id="synop-table">
      <thead><tr><th>ICAO</th><th>Raw SYNOP</th></tr></thead>
      <tbody id="synop"></tbody>
    </table>
  </div>

  <script>
  (async function(){
    const proxy    = 'https://api.allorigins.win/raw?url=';
    const stations = ['TNCA','TNCB','TNCC','TNCM','SVMI','SVVA'];
    const tafEnds  = stations.slice(0,3).map(icao=>({
      icao, url:`https://tgftp.nws.noaa.gov/data/forecasts/taf/stations/${icao}.TXT`
    }));
    const synopEnds = [
      {icao:'TNCC', url:'https://tgftp.nws.noaa.gov/data/raw/si/sica20.tncc..txt'},
      {icao:'TNCC', url:'https://tgftp.nws.noaa.gov/data/raw/sm/smca01.tncc..txt'}
    ];

    let beepEnabled = true, testMode = false;
    const metarRows = {}, metarHist = {};
    const tafCells  = {}, synopCells = [];

    function pad(n){ return n<10?'0'+n:''+n; }
    function nowStamp(){
      const d=new Date();
      return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }
    function updateClocks(){
      const d=new Date();
      document.getElementById('local-clock').textContent = nowStamp();
      document.getElementById('utc-clock').textContent =
        `${pad(d.getUTCHours())}:${pad(d.getUTCMinutes())}:${pad(d.getUTCSeconds())}`;
    }
    setInterval(updateClocks,500); updateClocks();

    async function fetchText(url){
      const r = await fetch(proxy + encodeURIComponent(url));
      if(!r.ok) throw new Error('Fetch failed '+r.status);
      return r.text();
    }

    function cleanForParse(s){
      return s.replace(/\sRMK[\s\S]*/i,'')
              .replace(/\s(?:TEMPO|BECMG|PROB\d{2}|FM\d{6})[\s\S]*/i,'')
              .replace(/\bAUTO\b|\bCOR\b/gi,'').trim();
    }

    function parseMetar(raw){
      const t = cleanForParse(raw).split(/\s+/);
      const time  = t[1]||'--';
      const base  = t.find(x=>/^(?:VRB|\d{3})\d{2}(?:G\d{2})?KT$/.test(x))||'/////KT';
      const varG  = t.find(x=>/^\d{3}V\d{3}$/.test(x));
      const wind  = base + (varG ? ' '+varG : '');
      const vis   = t.find(x=>/^\d{4}$/.test(x))||'--';
      const wx    = t.filter(x=>/^(?:\+|-)?(?:VC)?(?:TS|SH|RA|DZ|SN|FG|BR)/.test(x)).join(' ')||'--';
      const cldM  = raw.match(/((?:FEW|SCT|BKN|OVC)\d{3}(?:TCU|CB)?)/gi)||[];
      const cld   = cldM.join(' ')||'--';
      const td    = t.find(x=>/^M?\d{2}\/M?\d{2}$/.test(x))||'--';
      const qp    = t.find(x=>/^Q\d{4}$/.test(x));
      let qnh='‚Äî';
      if(qp){
        const h=qp.slice(1), i=(parseInt(h)*0.02953).toFixed(2);
        qnh=`${h} - ${i}`;
      }
      const gust=+(base.match(/G(\d{2})/)?.[1]||0);
      let age=0;
      if(/^\d{6}Z$/.test(time)){
        const now=new Date(),
              dd=parseInt(time.slice(0,2)),
              hh=parseInt(time.slice(2,4)),
              mm=parseInt(time.slice(4,6));
        age=(Date.now() - Date.UTC(now.getUTCFullYear(),now.getUTCMonth(),dd,hh,mm))/60000;
      }
      return {time, wind, vis, wx, cld, td, qnh, gust, age};
    }

    function buildMetar(){
      const tb=document.getElementById('metar');
      tb.innerHTML='';
      stations.forEach(icao=>{
        const tr=document.createElement('tr'),
              trR=document.createElement('tr');
        trR.className='raw';
        tr.innerHTML=`
          <td class="station">${icao}</td>
          <td class="time">--</td>
          <td>--</td><td class="vis">--</td>
          <td>--</td><td>--</td>
          <td>--</td><td>--</td>`;
        trR.innerHTML=`
          <td colspan="8">
            <span class="raw-current">Waiting‚Ä¶</span>
            <span class="raw-past"></span>
          </td>`;
        tb.append(tr,trR);
        metarRows[icao]={row:tr,curr:trR.querySelector('.raw-current'),
                         past:trR.querySelector('.raw-past')};
        metarHist[icao]=[];
      });
    }

    function scheduleHighlight(cell){
      clearTimeout(cell._t);
      cell.classList.add('highlight');
      cell._t=setTimeout(()=>cell.classList.remove('highlight'),20*60*1000);
    }

    async function loadMetar(){
      const tb=document.getElementById('metar');
      stations.forEach((icao,i)=>{
        const row=tb.children[i*2], c=row.querySelectorAll('td');
        [0,2,3,4,5].forEach(idx=>c[idx].classList.remove('alert'));
      });
      for(const icao of stations){
        try{
          const txt = testMode
            ? `${icao} 121900Z AUTO COR 09025G35KT 0500 VCSH FEW013CB BKN016 28/24 Q1013`
            : await fetchText(`https://tgftp.nws.noaa.gov/data/observations/metar/stations/${icao}.TXT`);
          const raw=txt.trim().split(/\r?\n/).pop();
          const d=parseMetar(raw);
          const hist=metarHist[icao];
          const isNew=hist[0]&&hist[0]!==raw;
          if(!hist[0]||hist[0]!==raw){
            hist.unshift(raw);
            if(hist.length>2) hist.pop();
          }
          if(icao==='TNCA'&&beepEnabled&&(d.gust>=35||/TS/.test(d.wx))){
            new Audio('https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg').play();
          }
          if(isNew&&beepEnabled){
            new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg').play();
          }
          const idx=stations.indexOf(icao)*2;
          const row=tb.children[idx], c=row.querySelectorAll('td');
          const windA  = d.gust>0;
          const visA   = parseInt(d.vis,10)<=5000;
          const wxA    = d.wx!=='--';
          const cloudA = /(?:BKN|OVC|TCU|CB)/i.test(d.cld);
          if(windA)  c[2].classList.add('alert');
          if(visA)   c[3].classList.add('alert');
          if(wxA)    c[4].classList.add('alert');
          if(cloudA) c[5].classList.add('alert');
          if(windA||visA||wxA||cloudA) c[0].classList.add('alert');
          row.classList.toggle('stale', d.age>120);
          c[1].textContent = d.time; if(isNew) scheduleHighlight(c[1]);
          c[2].textContent = d.wind;
          c[3].textContent = d.vis;
          c[4].textContent = d.wx;
          c[5].textContent = d.cld;
          c[6].textContent = d.td;
          c[7].textContent = d.qnh;
          const rr=metarRows[icao];
          rr.curr.textContent = hist[0]||'';
          rr.past.textContent = hist[1]||'';
        }catch{}
      }
      document.getElementById('last-updated').textContent =
        `METAR last updated: ${nowStamp()}`;
    }

    function buildTaf(){
      const tb=document.getElementById('taf');
      tb.innerHTML='';
      tafEnds.forEach(({icao})=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td class="station">${icao}</td><td class="raw-current">Waiting‚Ä¶</td>`;
        tb.append(tr);
        tafCells[icao]=tr.querySelector('.raw-current');
      });
    }
    async function loadTaf(){
      for(const {icao,url} of tafEnds){
        try{
          let txt=testMode
            ? `${icao} 121900Z FM200000 28010KT 8000 SCT020`
            : await fetchText(url);
          const parts=txt.trim().replace(/\r?\n/g,' ').split(/\s+/);
          tafCells[icao].textContent=parts.slice(2).join(' ');
        }catch{tafCells[icao].textContent='N/A'}
      }
      document.getElementById('taf-updated').textContent =
        `TAF last updated: ${nowStamp()}`;
    }
    function buildSynop(){
      const tb=document.getElementById('synop'); tb.innerHTML='';
      synopEnds.forEach(({icao})=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td class="station">${icao}</td><td class="raw-current">Waiting‚Ä¶</td>`;
        tb.append(tr);
        synopCells.push(tr.querySelector('.raw-current'));
      });
    }
    async function loadSynop(){
      for(let i=0;i<synopEnds.length;i++){
        const {icao,url}=synopEnds[i];
        try{
          const txt=await fetchText(url);
          synopCells[i].textContent=`${icao} ${txt.trim().replace(/\r?\n/g,' ')}`;
        }catch{synopCells[i].textContent='N/A'}
      }
    }

    /* Bonaire Visibility */
    (function(){
      const URL='https://www.knmidc.org/weather/bonaire/?Current',
            REF=5*60*1000, ALERT=20000;
      const visEl=document.getElementById('vis-value'),
            tsEl=document.getElementById('vis-timestamp'),
            wd=document.getElementById('bonaire-vis-widget');
      async function upd(){
        let v='N/A', t=Date.now();
        try{
          const html=await fetch(proxy+encodeURIComponent(URL)).then(r=>r.text());
          const doc=new DOMParser().parseFromString(html,'text/html');
          doc.querySelectorAll('td').forEach(td=>{
            if(/Visibility/i.test(td.textContent)){
              const nxt=td.nextElementSibling;
              if(nxt) v=nxt.textContent.trim();
            }
          });
        }catch{}
        visEl.textContent=v;
        visEl.classList.toggle('low',parseInt(v,10)<ALERT);
        tsEl.textContent=`Updated ${new Date(t).toLocaleTimeString()}`;
      }
      wd.ondblclick=upd; upd(); setInterval(upd,REF);
    })();

    /* INIT */
    buildMetar();  await loadMetar();   setInterval(loadMetar,60*1000);
    buildTaf();    await loadTaf();     setInterval(loadTaf,10*60*1000);
    buildSynop();  await loadSynop();   setInterval(loadSynop,10*60*1000);

    /* Controls */
    document.getElementById('mute-btn').onclick = ()=>{
      beepEnabled = !beepEnabled;
      document.getElementById('mute-btn').textContent =
        beepEnabled?'Mute Beep':'Unmute Beep';
    };
    document.getElementById('refresh-btn').onclick = ()=>{
      loadMetar(); loadTaf(); loadSynop();
    };
    document.getElementById('test-btn').onclick = ()=>{
      testMode = !testMode;
      document.getElementById('test-btn').textContent =
        testMode?'Exit Test Mode':'Enter Test Mode';
      loadMetar(); loadTaf(); loadSynop();
    };

    /* Double-click to copy METAR */
    document.body.addEventListener('dblclick', async e=>{
      const td=e.target.closest('#metar td');
      if(!td) return;
      try{
        await navigator.clipboard.writeText(td.textContent.trim());
        td.classList.add('metar-copied');
        setTimeout(()=>td.classList.remove('metar-copied'),600);
      }catch{}
    });

  })();
  </script>
</body>
</html>

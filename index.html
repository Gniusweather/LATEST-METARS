<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>CAR/VEN METAR AND TAF</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@600;800&display=swap"
    rel="stylesheet"
  />

  <style>
    :root {
      --bg:        #101820;
      --panel:     #1a2a33;
      --line:      #2a3b47;
      --accent:    #66ffcc;
      --text:      #f2f2f2;
      --muted:     #4f5b62;
      --warn:      #ff6666;
      --highlight: var(--accent);
    }
    *, *::before, *::after { box-sizing: border-box; }

    body {
      margin:0; padding:24px;
      font-family:'Inter',sans-serif;
      background:var(--bg); color:var(--text);
      font-size:22px; line-height:1.4;
    }

    h1 {
      margin:0 0 16px;
      text-align:center;
      font-size:42px; font-weight:800;
      color:var(--accent);
    }

    #clocks {
      display:flex;
      justify-content:center;
      gap: 40px;
      font-size:24px;
      margin-bottom:20px;
      color:var(--accent);
    }

    #controls {
      text-align:center; margin-bottom:16px;
    }
    #controls button {
      background:var(--panel);
      color:var(--accent);
      border:2px solid var(--line);
      padding:8px 16px; font-size:18px;
      margin:0 8px; cursor:pointer;
    }
    #controls button:hover {
      background:var(--accent); color:var(--panel);
    }

    #error {
      text-align:center; color:var(--warn);
      font-size:22px; min-height:28px; margin-bottom:12px;
    }

    .table-wrapper { overflow-x:auto; margin-bottom:8px; }
    table {
      width:100%; border-collapse:collapse;
      font-family:monospace; font-size:30px;
    }
    th, td {
      border:2px solid var(--line); padding:12px 16px;
      text-align:center;
      user-select:none;
    }
    th {
      background:#003b5a; color:var(--accent);
      font-weight:700;
    }
    td.station {
      font-weight:700; color:var(--accent);
      font-size:36px;
    }
    td.time {
      font-size:32px; transition:background .5s,color .5s;
    }
    .highlight {
      background:var(--accent); color:var(--bg);
    }
    .alert {
      background:var(--warn); color:var(--bg);
    }
    tr.raw td {
      background:var(--panel); color:#d0d7de;
      text-align:left; font-size:20px; padding:8px 16px;
    }

    #last-updated, #taf-updated {
      font-size:14px; color:var(--muted); margin:8px 0;
    }

    #compact-taf {
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(360px,1fr));
      gap:16px; margin-bottom:8px;
    }
    .taf-card {
      background:var(--panel);
      border:2px solid var(--line);
      border-radius:8px; padding:16px;
    }
    .taf-code {
      font-family:monospace; font-weight:700;
      color:var(--accent); font-size:28px;
    }
    .taf-issue {
      font-size:20px; color:var(--muted); margin-left:12px;
    }
    .taf-body {
      margin-top:12px; font-family:monospace;
      font-size:22px; line-height:1.4; word-break:break-word;
    }
  </style>
</head>
<body>

  <h1>CAR/VEN METAR AND TAF</h1>

  <div id="clocks">
    <div>Local: <span id="local-clock">--:--:--</span></div>
    <div>UTC:   <span id="utc-clock">--:--:--</span></div>
  </div>

  <div id="controls">
    <button id="mute-btn">Mute Beep</button>
    <button id="refresh-btn">Refresh Now</button>
    <button id="test-btn">Enter Test Mode</button>
  </div>

  <div id="error"></div>

  <div class="table-wrapper">
    <table>
      <thead>
        <tr>
          <th>ICAO</th><th>Time</th><th>Wind</th><th>Vis</th>
          <th>Wx</th><th>Clouds</th><th>Temp/Dew</th><th>QNH</th>
        </tr>
      </thead>
      <tbody id="metar">
        <tr><td colspan="8">Loading METAR…</td></tr>
      </tbody>
    </table>
  </div>
  <div id="last-updated">METAR last updated: --:--:--</div>

  <div id="compact-taf">
    <div>Loading TAF…</div>
  </div>
  <div id="taf-updated">TAF last updated: --:--:--</div>

  <script>
  (async function(){
    const proxy    = 'https://api.allorigins.win/raw?url=';
    const stations = ['TNCA','TNCB','TNCC','TNCM','SVMI','SVVA'];
    const tafs     = [
      {c:'TNCC',u:'https://tgftp.nws.noaa.gov/data/raw/ft/ftnu31.tncc..txt'},
      {c:'EHDB',u:'https://tgftp.nws.noaa.gov/data/raw/ft/ftdc31.ehdb..txt'},
      {c:'TNCA',u:'https://tgftp.nws.noaa.gov/data/raw/ft/ftnu50.tnca..txt'}
    ];

    const metarTbody = document.getElementById('metar'),
          tafDiv      = document.getElementById('compact-taf'),
          errDiv      = document.getElementById('error'),
          lastUp      = document.getElementById('last-updated'),
          tafUp       = document.getElementById('taf-updated'),
          muteBtn     = document.getElementById('mute-btn'),
          refreshBtn  = document.getElementById('refresh-btn'),
          testBtn     = document.getElementById('test-btn');

    let prevTimes = {}, lastUpdateMillis = {}, beepEnabled = true, testMode = false;

    function pad(n){ return n<10?'0'+n:n; }
    function nowStamp(){
      const d=new Date();
      return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }
    function updateClocks(){
      const d=new Date();
      document.getElementById('local-clock').textContent =
        `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
      document.getElementById('utc-clock').textContent   =
        `${pad(d.getUTCHours())}:${pad(d.getUTCMinutes())}:${pad(d.getUTCSeconds())}`;
    }
    setInterval(updateClocks,500); updateClocks();

    function clean(s){
      return s
        .replace(/\s(?:TEMPO|BECMG|PROB\d{2}|FM\d{6})[\s\S]*/i,'')
        .replace(/\bAUTO\b|\bCOR\b/gi,'')
        .trim();
    }

    function parseM(raw){
      const tks = clean(raw).split(/\s+/);
      const time = tks[1]||'';
      const mainWind = tks.find(x=>
        /^(?:VRB|\d{3})\d{2}(?:G\d{2})?KT$/.test(x)
      )||'';
      const varWind = tks.filter(x=>/^\d{3}V\d{3}$/.test(x)).join(' ');
      const w       = [mainWind,varWind].filter(Boolean).join(' ');
      const hasGust = /G\d{2}/.test(mainWind);
      const gustVal = +(mainWind.match(/G(\d{2})/)?.[1]||0);
      const vis    = tks.find(x=>/^\d{4}$/.test(x))||'';
      const visNum = parseInt(vis,10)||9999;
      const lowVis = visNum<5000;
      const wx     = tks.filter(x=>
        /^(?:\+|-)?(?:VC)?(?:MI|PR|BC|DR|BL|SH|TS|FZ)?(?:DZ|RA|SN|SG|PL|GR|GS|UP|BR|FG|FU|DU|SA|HZ|PY|PO|SQ|FC|SS|DS|VA)$/.test(x)
      ).join(' ');
      const hasWx  = !!wx;
      const cl     = tks.filter(x=>/^(?:FEW|SCT|BKN|OVC).*/.test(x)).join(' ');
      const hasCB  = /TCU|CB/.test(cl);
      const td     = tks.find(x=>/^M?\d{2}\/M?\d{2}$/.test(x))||'';
      const qp     = tks.find(x=>/^Q\d{4}$/.test(x));
      const qnh    = qp ? `${qp.slice(1)}-${(parseInt(qp.slice(1))*0.02953).toFixed(2)}` : '—';
      return { time, w, vis, wx, cl, td, qnh, hasGust, gustVal, lowVis, hasWx, hasCB };
    }

    async function ftxt(url){
      const r = await fetch(proxy + encodeURIComponent(url));
      if(!r.ok) throw r;
      return r.text();
    }

    async function loadM(){
      let rows='', err='';

      if (testMode) {
        for (let c of stations) {
          const raw = `${c} 121200Z 09025G36KT 5000 2000N +TSRA FEW///CB BKN016TCU`;
          const d   = parseM(raw);

          // fire alarm if gust≥35 or TSRA
          if (d.gustVal>=35 || /TSRA/.test(d.wx)) {
            new Audio('https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg').play();
          }

          const hasAlert = d.hasGust || d.lowVis || d.hasWx || d.hasCB;
          rows += `
            <tr>
              <td class="station${hasAlert?' alert':''}">${c}</td>
              <td class="time highlight">${d.time}</td>
              <td>${d.w}</td>
              <td>${d.vis}</td>
              <td>${d.wx}</td>
              <td>${d.cl}</td>
              <td>${d.td}</td>
              <td>${d.qnh}</td>
            </tr>
            <tr class="raw"><td colspan="8">${raw}</td></tr>`;
        }
        metarTbody.innerHTML = rows;
        lastUp.textContent    = 'METAR test mode';
        return;
      }

      // live mode
      for (let c of stations) {
        try {
          const txt   = await ftxt(`https://tgftp.nws.noaa.gov/data/observations/metar/stations/${c}.TXT`);
          const lines = txt.trim().split(/\r?\n/).filter(Boolean);
          const raw   = lines.pop();
          const d     = parseM(raw);

          if(c==='TNCA' && beepEnabled && (d.gustVal>=35 || /TS/.test(d.wx))) {
            new Audio('https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg').play();
          }

          const changed = prevTimes[c] && prevTimes[c]!==d.time;
          if (changed && beepEnabled) {
            lastUpdateMillis[c]=Date.now();
            new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg').play();
          }
          if (!prevTimes[c]) lastUpdateMillis[c]=Date.now();
          prevTimes[c]=d.time;
          const age   = Date.now() - (lastUpdateMillis[c]||0);
          const isNew = age < 10*60*1000;
          const hasAlert = d.hasGust || d.lowVis || d.hasWx || d.hasCB;

          rows += `
            <tr>
              <td class="station${hasAlert?' alert':''}">${c}</td>
              <td class="time${isNew?' highlight':''}">${d.time}</td>
              <td>${d.w}</td>
              <td>${d.vis}</td>
              <td>${d.wx}</td>
              <td>${d.cl}</td>
              <td>${d.td}</td>
              <td>${d.qnh}</td>
            </tr>
            <tr class="raw"><td colspan="8">${raw}</td></tr>`;
        }
        catch(e){
          err += `Error ${c} `;
        }
      }

      metarTbody.innerHTML = rows;
      errDiv.textContent    = err;
      lastUp.textContent    = `METAR last updated: ${nowStamp()}`;
    }

    async function loadT(){
      let cards='', err='';
      for (let tf of tafs) {
        try {
          const txt   = await ftxt(tf.u);
          const s     = clean(txt.replace(/\s+/g,' '));
          const issue = (s.match(/\b\d{4}Z\b/)||[])[0]||'';
          cards += `
            <div class="taf-card">
              <div>
                <span class="taf-code">${tf.c}</span>
                <span class="taf-issue">${issue}</span>
              </div>
              <div class="taf-body">${s}</div>
            </div>`;
        }
        catch(e){
          err += `Error ${tf.c} `;
        }
      }
      tafDiv.innerHTML    = cards;
      errDiv.textContent += err;
      tafUp.textContent   = `TAF last updated: ${nowStamp()}`;
    }

    document.querySelector('table').addEventListener('dblclick', e => {
      const td = e.target.closest('td');
      if (!td || td.closest('tr').classList.contains('raw')) return;
      const text = td.textContent.trim();
      if (!text) return;
      navigator.clipboard.writeText(text).then(() => {
        td.classList.add('highlight');
        setTimeout(() => td.classList.remove('highlight'), 500);
      });
    });

    muteBtn.addEventListener('click',()=>{
      beepEnabled=!beepEnabled;
      muteBtn.textContent=beepEnabled?'Mute Beep':'Unmute Beep';
    });
    refreshBtn.addEventListener('click',()=>{
      loadM(); loadT();
    });
    testBtn.addEventListener('click',()=>{
      testMode=!testMode;
      testBtn.textContent=testMode?'Exit Test Mode':'Enter Test Mode';
      loadM();
    });

    await loadM();
    await loadT();
    setInterval(loadM,60*1000);
    setInterval(loadT,10*60*1000);
  })();
  </script>
</body>
</html>
```
